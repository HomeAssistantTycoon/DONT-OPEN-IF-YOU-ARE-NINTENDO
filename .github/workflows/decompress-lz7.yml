name: Decompress LZ7 and Extract Contents

on:
  workflow_dispatch:

jobs:
  decompress_and_extract:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Create output folder
        run: mkdir -p output

      - name: Download SZS Tools
        run: |
          mkdir -p tools
          wget https://szs.wiimm.de/download/szs-v2.42a-r8989-x86_64.tar.gz -O tools/szs-tools.tar.gz
          tar -xzf tools/szs-tools.tar.gz -C tools
          chmod +x tools/wszst

      - name: Decompress LZ7 file
        run: |
          # Replace input_file.lz7 with the path to your LZ7 file
          INPUT_FILE="input_file.lz7"
          DECOMP_FILE="output/decompressed_file"

          # Decompress LZ7 to a file (wszst automatically chooses LZ method)
          ./tools/wszst lz7 x "$INPUT_FILE" -o "$DECOMP_FILE"

          # Detect file type (SZS or ARC)
          FILE_HEADER=$(head -c 4 "$DECOMP_FILE" | xxd -p)

          if [[ "$FILE_HEADER" == "53435a00" ]]; then
              echo "Detected SZS file, extracting..."
              ./tools/wszst szs x "$DECOMP_FILE" -o output/
          elif [[ "$FILE_HEADER" == "41524300" ]]; then
              echo "Detected ARC file, extracting..."
              ./tools/wszst arc x "$DECOMP_FILE" -o output/
          else
              echo "Unknown file type, saved decompressed file as-is."
              mv "$DECOMP_FILE" "output/"
          fi

      - name: Commit output folder to repo
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add output/
          git commit -m "Add decompressed and extracted files from LZ7"
          git push
